<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nigerian E-commerce App</title>
  <!-- Include Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Include Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-gray-100">
  <div class="max-w-2xl mx-auto p-4">
    <!-- Upload Button -->
    <button id="uploadButton" class="w-full bg-green-600 text-white p-2 rounded-lg hover:bg-green-700 mb-6">
      Upload Item
    </button>

    <!-- Upload Form (Hidden by Default) -->
    <div id="uploadFormContainer" class="bg-white shadow-lg rounded-lg p-6 mb-6 hidden">
      <h2 class="text-2xl font-semibold mb-4">Upload Item</h2>
      <form id="uploadForm" class="space-y-4">
  <input type="text" id="name" placeholder="Item Name" class="w-full p-2 border rounded-lg" required>
  <div class="flex space-x-4">
    <input type="number" id="price" placeholder="Price" class="w-full p-2 border rounded-lg" required step="0.01">
    <select id="currency" class="w-1/3 p-2 border rounded-lg" required>
      <option value="NGN">₦ NGN (Nigerian Naira)</option>
      <option value="USD">$ USD (US Dollar)</option>
      <option value="GBP">£ GBP (British Pound)</option>
      <option value="KES">KSh KES (Kenyan Shilling)</option>
      <option value="GHS">₵ GHS (Ghanaian Cedi)</option>
      <option value="ZAR">R ZAR (South African Rand)</option>
      <option value="XAF">FCFA XAF (Central African CFA Franc)</option>
      <option value="XOF">CFA XOF (West African CFA Franc)</option>
      <option value="ETB">Br ETB (Ethiopian Birr)</option>
      <option value="EGP">£ EGP (Egyptian Pound)</option>
    </select>
  </div>
  <textarea id="description" placeholder="Item Description" class="w-full p-2 border rounded-lg" required></textarea>
  <input type="text" id="location" placeholder="Location" class="w-full p-2 border rounded-lg" required>
  <select id="category" class="w-full p-2 border rounded-lg" required>
    <option value="">Select Category</option>
    <option value="Electronics">Electronics</option>
    <option value="Fashion">Fashion</option>
    <option value="Home & Garden">Home & Garden</option>
    <option value="Vehicles">Vehicles</option>
    <option value="Real Estate">Real Estate</option>
    <option value="Health & Beauty">Health & Beauty</option>
    <option value="Sports & Fitness">Sports & Fitness</option>
    <option value="Books & Stationery">Books & Stationery</option>
    <option value="Food & Groceries">Food & Groceries</option>
    <option value="Others">Others</option>
  </select>
  <div class="space-y-2">
    <label for="media" class="block text-sm font-medium text-gray-700">Upload Images (Max 3)</label>
    <input type="file" id="images" name="media" accept="image/*" class="w-full p-2 border rounded-lg" multiple max="3" required>
    <div id="imagePreview" class="flex space-x-2"></div>
  </div>
  <button type="submit" class="w-full bg-green-600 text-white p-2 rounded-lg hover:bg-green-700">Upload</button>
</form>
      <!-- Error Message -->
      <div id="uploadError" class="text-red-500 mt-2 hidden"></div>
      
      <div id="notification" class="text-red-500 mt-2 hidden"></div>
    </div>

    <!-- Search -->
    <div class="bg-white shadow-lg rounded-lg p-6 mb-6">
      <h2 class="text-2xl font-semibold mb-4">Search Items</h2>
      <input type="text" id="searchQuery" placeholder="Search by name, category, or location" class="w-full p-2 border rounded-lg">
    </div>

    <!-- Display Posted Items -->
    <div id="postedItems" class="space-y-4"></div>
  </div>

  <!-- JavaScript for Interactivity -->
  <script>
    // Fetch and display posted items
    async function fetchItems() {
      try {
        const response = await fetch('https://afrimart-zbj3.onrender.com/api/items');
        if (!response.ok) {
          throw new Error('Failed to fetch items');
        }
        const items = await response.json();
        displayItems(items);
      } catch (error) {
        console.error('Error fetching items:', error);
        alert('Failed to fetch items. Please try again later.');
      }
    }

    // Display items
    function displayItems(items) {
      const postedItems = document.getElementById('postedItems');
      postedItems.innerHTML = '';

      items.forEach((item) => {
        const itemHTML = `
          <div class="bg-white shadow-lg rounded-lg overflow-hidden">
            <div class="p-6">
              <div class="flex justify-between items-center">
                <div class="flex items-center space-x-4">
                  <div class="h-12 w-12 rounded-full bg-gray-200 flex items-center justify-center">
                    <img src="${item.user.avatar}" alt="User Avatar" class="rounded-full">
                  </div>
                  <div>
                    <div class="flex items-center">
                      <h2 class="text-xl font-semibold">${item.user.name}</h2>
                      <i data-lucide="check-circle" class="w-5 h-5 text-blue-500 ml-2"></i>
                    </div>
                    <div class="flex items-center text-sm text-gray-500">
                      <i data-lucide="map-pin" class="w-4 h-4 mr-1"></i>
                      ${item.location}
                      <i data-lucide="timer" class="w-4 h-4 ml-3 mr-1"></i>
                      2 hours ago
                    </div>
                  </div>
                </div>
              </div>

              <div class="mt-4">
                <div class="grid grid-cols-3 gap-2">
                  ${item.images.map((image) => `
                    <img src="${image}" alt="Product Image" class="w-full h-32 object-cover rounded-lg">
                  `).join('')}
                </div>
              </div>

              <div class="mt-4">
                <h2 class="text-2xl font-semibold">${item.title}</h2>
                <div class="flex items-center space-x-2 mt-2">
                  <span class="text-2xl font-bold text-green-600">${item.currency} ${item.price}</span>
                  <span class="bg-orange-100 text-orange-600 px-2 py-1 rounded-full text-sm">Negotiable</span>
                </div>
                <p class="mt-2 text-gray-600">${item.description}</p>
                <p class="mt-2 text-sm text-gray-500">Category: ${item.category}</p>
              </div>
            </div>
          </div>
        `;
        postedItems.insertAdjacentHTML('beforeend', itemHTML);
      });

      // Initialize Lucide Icons
      lucide.createIcons();
    }

document.addEventListener("DOMContentLoaded", function () {
  const form = document.getElementById("uploadForm");
  const imageInput = document.getElementById("images");
  const imagePreview = document.getElementById("imagePreview");
  const notification = document.getElementById("notification");

  function showNotification(message, type = "error") {
    notification.textContent = message;
    notification.className = `fixed top-4 right-4 p-4 rounded-lg text-white ${type === "error" ? "bg-red-500" : "bg-green-500"}`;
    setTimeout(() => {
      notification.classList.add("opacity-0");
      setTimeout(() => notification.textContent = "", 300);
    }, 3000);
  }

  function validateFiles(files) {
    if (files.length > 3) {
      throw new Error("Maximum 3 files allowed");
    }
    files.forEach(file => {
      if (!file.type.startsWith("image/")) {
        throw new Error(`Invalid file type: ${file.type}. Only images are allowed.`);
      }
      if (file.size > 5 * 1024 * 1024) {
        throw new Error(`File ${file.name} is too large. Maximum size is 5MB.`);
      }
    });
  }

  imageInput.addEventListener("change", function (e) {
    try {
      const files = Array.from(e.target.files);
      validateFiles(files);
      imagePreview.innerHTML = "";
      files.forEach(file => {
        const reader = new FileReader();
        reader.onload = (event) => {
          const img = document.createElement("img");
          img.src = event.target.result;
          img.classList.add("w-24", "h-24", "object-cover", "rounded-lg", "m-2");
          imagePreview.appendChild(img);
        };
        reader.readAsDataURL(file);
      });
    } catch (error) {
      showNotification(error.message);
      e.target.value = "";
      imagePreview.innerHTML = "";
    }
  });

  form.addEventListener("submit", async function (event) {
    event.preventDefault();
    const submitButton = form.querySelector("button[type='submit']");
    const token = localStorage.getItem("token");
    if (!token) {
      showNotification("Please log in to upload items");
      return;
    }
    try {
      submitButton.disabled = true;
      submitButton.textContent = "Uploading...";
      
      const formData = new FormData(form);
      const response = await fetch("https://afrimart-zbj3.onrender.com/api/items", {
        method: "POST",
        headers: { "Authorization": `Bearer ${token}` },
        body: formData
      });
      
      const responseData = await response.json();
      if (!response.ok) {
        throw new Error(responseData.error || "Failed to upload item");
      }
      showNotification("Item uploaded successfully!", "success");
      form.reset();
      imagePreview.innerHTML = "";
    } catch (error) {
      showNotification(error.message || "Failed to upload item");
    } finally {
      submitButton.disabled = false;
      submitButton.textContent = "Upload";
    }
  });
});


// Utility function to validate files
function validateFiles(files) {
    const maxFiles = 10;
    const maxSize = 10 * 1024 * 1024; // 10MB
    const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'video/mp4'];
    
    if (files.length > maxFiles) {
        throw new Error(`Maximum ${maxFiles} files allowed`);
    }
    
    for (const file of files) {
        if (!allowedTypes.includes(file.type)) {
            throw new Error(`Invalid file type: ${file.type}. Only JPEG, PNG, GIF and MP4 are allowed.`);
        }
        if (file.size > maxSize) {
            throw new Error(`File ${file.name} is too large. Maximum size is 10MB`);
        }
    }
}

// Utility function to show notifications
function showNotification(message, type = 'error') {
    const notification = document.getElementById('notification') || createNotificationElement();
    notification.textContent = message;
    notification.className = `fixed top-4 right-4 p-4 rounded-lg ${
        type === 'error' ? 'bg-red-500' : 'bg-green-500'
    } text-white`;
    
    setTimeout(() => {
        notification.classList.add('opacity-0');
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// Create notification element if it doesn't exist
function createNotificationElement() {
    const notification = document.createElement('div');
    notification.id = 'notification';
    document.body.appendChild(notification);
    return notification;
}

// Handle image preview
function setupImagePreview() {
    const imageInput = document.getElementById('images');
    const imagePreview = document.getElementById('imagePreview');
    
    imageInput.addEventListener('change', async (e) => {
        try {
            const files = Array.from(e.target.files);
            validateFiles(files);
            
            imagePreview.innerHTML = '';
            
            for (const file of files) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = document.createElement('img');
                    img.src = event.target.result;
                    img.classList.add('w-24', 'h-24', 'object-cover', 'rounded-lg', 'm-2');
                    
                    const container = document.createElement('div');
                    container.classList.add('relative', 'inline-block');
                    
                    const removeButton = document.createElement('button');
                    removeButton.innerHTML = '×';
                    removeButton.classList.add(
                        'absolute', 'top-0', 'right-0', 
                        'bg-red-500', 'text-white', 
                        'rounded-full', 'w-6', 'h-6',
                        'flex', 'items-center', 'justify-center',
                        'hover:bg-red-600', 'cursor-pointer'
                    );
                    
                    removeButton.onclick = () => {
                        container.remove();
                        updateFileInput(files.filter(f => f !== file), imageInput);
                    };
                    
                    container.appendChild(img);
                    container.appendChild(removeButton);
                    imagePreview.appendChild(container);
                };
                reader.readAsDataURL(file);
            }
        } catch (error) {
            showNotification(error.message);
            e.target.value = ''; // Clear the input
            imagePreview.innerHTML = '';
        }
    });
}

// Update file input after removing a file
function updateFileInput(remainingFiles, inputElement) {
    const dataTransfer = new DataTransfer();
    remainingFiles.forEach(file => dataTransfer.items.add(file));
    inputElement.files = dataTransfer.files;
}

// Handle form submission
async function handleSubmit(event) {
    event.preventDefault();
    
    const form = event.target;
    const submitButton = form.querySelector('button[type="submit"]');
    const originalButtonText = submitButton.textContent;
    
    try {
        // Validate authentication
        const token = localStorage.getItem('token');
        if (!token) {
            throw new Error('Please log in to upload items');
        }
        
        // Show loading state
        submitButton.disabled = true;
        submitButton.textContent = 'Uploading...';
        
        // Validate required fields
        const requiredFields = ['name', 'price', 'description', 'location', 'category'];
        for (const fieldId of requiredFields) {
            const field = document.getElementById(fieldId);
            if (!field.value.trim()) {
                throw new Error(`Please fill in the ${fieldId.replace(/([A-Z])/g, ' $1').toLowerCase()}`);
            }
        }
        
        // Validate files
     /**   const files = Array.from(document.getElementById('images').files);
        if (files.length === 0) {
            throw new Error('Please select at least one image');
        }
        validateFiles(files);
        
        // Prepare form data to match server schema
        const formData = new FormData();
        formData.append('name', document.getElementById('name').value.trim()); // Changed from 'title' to 'name'
        formData.append('price', parseFloat(document.getElementById('price').value.trim()));
        formData.append('currency', document.getElementById('currency').value);
        formData.append('description', document.getElementById('description').value.trim());
        formData.append('location', document.getElementById('location').value.trim());
        formData.append('category', document.getElementById('category').value);**/
      
      const formData = new FormData();
formData.append("name", document.getElementById("name").value.trim());
formData.append("price", document.getElementById("price").value.trim());
formData.append("currency", document.getElementById("currency").value);
formData.append("description", document.getElementById("description").value.trim());
formData.append("location", document.getElementById("location").value.trim());
formData.append("category", document.getElementById("category").value);

//const files = document.getElementById("images").files;
      const filesInput = document.getElementById("images");

      const files = filesInput.files ? Array.from(filesInput.files) : [];

for (const file of files) {
    formData.append("media", file);
}

// Debug: Log form data before sending
for (let pair of formData.entries()) {
    console.log(`${pair[0]}:`, pair[1]);
}

const response = await fetch("https://thrift-backend-rose.vercel.app/api/items", {
    method: "POST",
    headers: {
        "Authorization": `Bearer ${token}`,
    },
    body: formData
});
        
      
if (files.length === 0) {
    throw new Error("Please select at least one image.");
}

// ✅ Now `files` is a proper array, and `forEach` will work
files.forEach(file => {
    formData.append("media", file);
});
        // Append files as 'media' array
      /**  files.forEach(file => {
            formData.append('media', file); // Changed from 'media[]' to 'media'
        });"**/
        
        // Make the request
    /**    const response = await fetch('https://thrift2.vercel.app/api/items', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`
            },
            body: formData
        });
        
        const responseData = await response.json();
        
        if (!response.ok) {
            // Extract error message from server response
            const errorMessage = responseData.error || 'Failed to upload item';
            throw new Error(errorMessage);
        }
        **/
        // Handle success
        showNotification('Item uploaded successfully!', 'success');
        form.reset();
        document.getElementById('imagePreview').innerHTML = '';
        document.getElementById('uploadFormContainer').classList.add('hidden');
        
        // Refresh items list if function exists
        if (typeof fetchItems === 'function') {
            await fetchItems();
        }
        
    } catch (error) {
        console.error('Upload error:', error);
        showNotification(error.message);
    } finally {
        // Reset button state
        submitButton.disabled = false;
        submitButton.textContent = originalButtonText;
    }
}

// Initialize form handling
function initializeForm() {
    const form = document.getElementById('uploadForm');
    const uploadButton = document.getElementById('uploadButton');
    const uploadFormContainer = document.getElementById('uploadFormContainer');
    
    // Setup form submission
    form.addEventListener('submit', handleSubmit);
    
    // Setup upload button toggle
    uploadButton.addEventListener('click', () => {
        uploadFormContainer.classList.toggle('hidden');
    });
    
    // Setup image preview
    setupImagePreview();
    
    // Setup price input validation
    const priceInput = document.getElementById('price');
    if (priceInput) {
        priceInput.addEventListener('input', (e) => {
            const value = e.target.value.replace(/[^0-9.]/g, '');
            const parts = value.split('.');
            if (parts.length > 2) {
                e.target.value = parts[0] + '.' + parts.slice(1).join('');
            } else {
                e.target.value = value;
            }
        });
    }
}

// Initialize everything when DOM is loaded
document.addEventListener('DOMContentLoaded', initializeForm);
  </script>
</body>
</html>