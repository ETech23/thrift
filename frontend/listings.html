<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nigerian E-commerce App</title>
  <!-- Include Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Include Lucide Icons -->
  <!-- Development version -->
<script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

<!-- Production version -->
<script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-gray-100">
  <div class="max-w-2xl mx-auto p-4">
    <!-- Upload Button -->
    <button id="uploadButton" class="w-full bg-green-600 text-white p-2 rounded-lg hover:bg-green-700 mb-6">
      Upload Item
    </button>

    <!-- Upload Form (Hidden by Default) -->
    <div id="uploadFormContainer" class="bg-white shadow-lg rounded-lg p-6 mb-6 hidden">
      <h2 class="text-2xl font-semibold mb-4">Upload Item</h2>
      <form id="uploadForm" class="space-y-4">
  <input type="text" id="name" placeholder="Item Name" class="w-full p-2 border rounded-lg" required>
  <div class="flex space-x-4">
    <input type="number" id="price" placeholder="Price" class="w-full p-2 border rounded-lg" required step="0.01">
    <select id="currency" class="w-1/3 p-2 border rounded-lg" required>
      <option value="NGN">₦ NGN (Nigerian Naira)</option>
      <option value="USD">$ USD (US Dollar)</option>
      <option value="GBP">£ GBP (British Pound)</option>
      <option value="KES">KSh KES (Kenyan Shilling)</option>
      <option value="GHS">₵ GHS (Ghanaian Cedi)</option>
      <option value="ZAR">R ZAR (South African Rand)</option>
      <option value="XAF">FCFA XAF (Central African CFA Franc)</option>
      <option value="XOF">CFA XOF (West African CFA Franc)</option>
      <option value="ETB">Br ETB (Ethiopian Birr)</option>
      <option value="EGP">£ EGP (Egyptian Pound)</option>
    </select>
  </div>
  <textarea id="description" placeholder="Item Description" class="w-full p-2 border rounded-lg" required></textarea>
  <input type="text" id="location" placeholder="Location" class="w-full p-2 border rounded-lg" required>
  <select id="category" class="w-full p-2 border rounded-lg" required>
    <option value="">Select Category</option>
    <option value="Electronics">Electronics</option>
    <option value="Fashion">Fashion</option>
    <option value="Home & Garden">Home & Garden</option>
    <option value="Vehicles">Vehicles</option>
    <option value="Real Estate">Real Estate</option>
    <option value="Health & Beauty">Health & Beauty</option>
    <option value="Sports & Fitness">Sports & Fitness</option>
    <option value="Books & Stationery">Books & Stationery</option>
    <option value="Food & Groceries">Food & Groceries</option>
    <option value="Others">Others</option>
  </select>
  <div class="space-y-2">
    <label for="media" class="block text-sm font-medium text-gray-700">Upload Images (Max 8)</label>
    <input type="file" id="images" name="media" accept="image/*" class="w-full p-2 border rounded-lg" multiple max="3" required>
    <div id="imagePreview" class="flex space-x-2"></div>
  </div>
  <button type="submit" class="w-full bg-green-600 text-white p-2 rounded-lg hover:bg-green-700">Upload</button>
</form>
      <!-- Error Message -->
      <div id="uploadError" class="text-red-500 mt-2 hidden"></div>
      
      <div id="notification" class="text-red-500 mt-2 hidden"></div>
    </div>

    <!-- Search -->
    <div class="bg-white shadow-lg rounded-lg p-6 mb-6">
      <h2 class="text-2xl font-semibold mb-4">Search Items</h2>
      <input type="text" id="searchQuery" placeholder="Search by name, category, or location" class="w-full p-2 border rounded-lg">
    </div>

    <!-- Display Posted Items -->
    <div id="postedItems" class="space-y-4"></div>
  </div>

  <!-- JavaScript for Interactivity -->
<script type="module">
    import { createIcons, icons } from 'https://cdn.jsdelivr.net/npm/lucide@0.263.1/dist/umd/lucide.min.js';

    createIcons({
        icons: icons
    });
  </script>
  <script>

  // Configuration
const CONFIG = {
  API_BASE_URL: 'https://thrift-backend-rose.vercel.app/api',
  UPLOAD_SETTINGS: {
    MAX_FILES: 8,
    MAX_FILE_SIZE: 50 * 1024 * 1024, // 50MB
    ALLOWED_TYPES: ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'],
    MAX_DIMENSION: 1000 // matches Cloudinary transformation
  },
  DEBOUNCE_DELAY: 300
};

// Utility Functions
class UploadError extends Error {
  constructor(message, technical = '') {
    super(message);
    this.technical = technical;
    this.name = 'UploadError';
  }
}

const getAuthToken = () => localStorage.getItem('token');

const formatFileSize = (bytes) => {
  if (bytes === 0) return '0 Bytes';
  const k = 1024;
  const sizes = ['Bytes', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
};

const showNotification = (() => {
  let currentTimeout;
  return (message, type = 'error') => {
    const notification = document.getElementById('notification');
    if (!notification) return;

    clearTimeout(currentTimeout);
    notification.textContent = message;
    notification.className = `fixed top-4 right-4 p-4 rounded-lg text-white ${
      type === 'error' ? 'bg-red-500' : 'bg-green-500'
    } z-50 transition-opacity duration-300`;
    notification.classList.remove('hidden');
    
    currentTimeout = setTimeout(() => {
      notification.classList.add('opacity-0');
      setTimeout(() => {
        notification.classList.add('hidden');
        notification.classList.remove('opacity-0');
      }, 300);
    }, 3000);
  };
})();

const validateFiles = (files) => {
  if (!files || files.length === 0) {
    throw new UploadError('Please select at least one image');
  }

  if (files.length > CONFIG.UPLOAD_SETTINGS.MAX_FILES) {
    throw new UploadError(`Maximum ${CONFIG.UPLOAD_SETTINGS.MAX_FILES} files allowed`);
  }

  for (const file of files) {
    if (!CONFIG.UPLOAD_SETTINGS.ALLOWED_TYPES.includes(file.type)) {
      throw new UploadError(
        'Invalid file type. Only JPEG, JPG, PNG, and GIF files are allowed',
        `File type: ${file.type}`
      );
    }

    if (file.size > CONFIG.UPLOAD_SETTINGS.MAX_FILE_SIZE) {
      throw new UploadError(
        `File ${file.name} exceeds size limit of ${formatFileSize(CONFIG.UPLOAD_SETTINGS.MAX_FILE_SIZE)}`,
        `File size: ${formatFileSize(file.size)}`
      );
    }
  }
};

// UI Functions
const createLoadingSkeleton = () => {
  return `
    <div class="animate-pulse">
      <div class="h-48 bg-gray-200 rounded-lg mb-4"></div>
      <div class="h-4 bg-gray-200 rounded w-3/4 mb-2"></div>
      <div class="h-4 bg-gray-200 rounded w-1/2"></div>
    </div>
  `;
};

const createItemElement = (item) => {
  const itemDiv = document.createElement('div');
  itemDiv.className = 'bg-white shadow-lg rounded-lg overflow-hidden';
  
  itemDiv.innerHTML = `
    <div class="p-6">
      <div class="flex justify-between items-center">
        <div class="flex items-center space-x-4">
          <div class="h-12 w-12 rounded-full bg-gray-200 flex items-center justify-center">
            <img src="${item.user?.avatar || '/placeholder-avatar.png'}" 
                 alt="User Avatar" 
                 class="rounded-full"
                 onerror="this.src='/placeholder-avatar.png'">
          </div>
          <div>
            <div class="flex items-center">
              <h2 class="text-xl font-semibold">${item.user?.name || 'Anonymous'}</h2>
              ${item.user?.verified ? '<i data-lucide="check-circle" class="w-5 h-5 text-blue-500 ml-2"></i>' : ''}
            </div>
            <div class="flex items-center text-sm text-gray-500">
              <i data-lucide="map-pin" class="w-4 h-4 mr-1"></i>
              ${item.location}
              <i data-lucide="clock" class="w-4 h-4 ml-3 mr-1"></i>
              ${new Date(item.createdAt).toLocaleDateString()}
            </div>
          </div>
        </div>
      </div>

      <div class="mt-4">
        <div class="grid grid-cols-${Math.min(item.images.length, 3)} gap-2">
          ${item.images.map(image => `
            <img src="${image}" 
                 alt="Product Image" 
                 class="w-full h-32 object-cover rounded-lg"
                 onerror="this.src='/placeholder-product.png'">
          `).join('')}
        </div>
      </div>

      <div class="mt-4">
        <h2 class="text-2xl font-semibold">${item.name}</h2>
        <div class="flex items-center space-x-2 mt-2">
          <span class="text-2xl font-bold text-green-600">${item.currency} ${parseFloat(item.price).toLocaleString()}</span>
          <span class="bg-orange-100 text-orange-600 px-2 py-1 rounded-full text-sm">Negotiable</span>
        </div>
        <p class="mt-2 text-gray-600">${item.description}</p>
        <p class="mt-2 text-sm text-gray-500">Category: ${item.category}</p>
      </div>
    </div>
  `;

  return itemDiv;
};

// Image Preview Handling
const handleImagePreview = (() => {
  let currentFiles = [];

  const updateFileList = (fileInput, files) => {
    const dataTransfer = new DataTransfer();
    files.forEach(file => dataTransfer.items.add(file));
    fileInput.files = dataTransfer.files;
    currentFiles = files;
  };

  return (event) => {
    const files = Array.from(event.target.files);
    const previewContainer = document.getElementById('imagePreview');
    const fileInput = event.target;

    try {
      validateFiles(files);
      previewContainer.innerHTML = '';
      currentFiles = files;
      
      files.forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const previewDiv = document.createElement('div');
          previewDiv.className = 'relative inline-block';
          previewDiv.innerHTML = `
            <div class="relative group">
              <img src="${e.target.result}" 
                   class="w-24 h-24 object-cover rounded-lg m-2">
              <div class="absolute inset-0 bg-black bg-opacity-50 opacity-0 group-hover:opacity-100 
                          transition-opacity duration-200 rounded-lg m-2 flex items-center justify-center">
                <button type="button" class="text-white hover:text-red-500 transition-colors duration-200">
                  <i data-lucide="trash-2" class="w-6 h-6"></i>
                </button>
              </div>
            </div>
            <span class="absolute bottom-0 right-0 bg-gray-800 text-white text-xs px-2 py-1 rounded-full m-3">
              ${formatFileSize(file.size)}
            </span>
          `;

          previewDiv.querySelector('button').onclick = () => {
            previewDiv.remove();
            currentFiles = currentFiles.filter((_, i) => i !== index);
            updateFileList(fileInput, currentFiles);
          };

          previewContainer.appendChild(previewDiv);
          lucide.createIcons();
        };
        reader.readAsDataURL(file);
      });
    } catch (error) {
      showNotification(error.message);
      event.target.value = '';
      previewContainer.innerHTML = '';
      currentFiles = [];
    }
  };
})();

// API Functions
const fetchItems = async (searchQuery = '') => {
  const container = document.getElementById('postedItems');
  container.innerHTML = Array(4).fill(createLoadingSkeleton()).join('');

  try {
    const url = new URL(`${CONFIG.API_BASE_URL}/items`);
    if (searchQuery) {
      url.searchParams.append('search', searchQuery);
    }

    const response = await fetch(url.toString());
    if (!response.ok) {
      throw new Error('Failed to fetch items');
    }

    const items = await response.json();
    container.innerHTML = '';
    
    if (items.length === 0) {
      container.innerHTML = `
        <div class="text-center py-8">
          <i data-lucide="package-search" class="w-16 h-16 mx-auto text-gray-400 mb-4"></i>
          <p class="text-gray-500">No items found</p>
        </div>
      `;
      lucide.createIcons();
      return;
    }

    items.forEach(item => {
      container.appendChild(createItemElement(item));
    });

    lucide.createIcons();
  } catch (error) {
    console.error('Error fetching items:', error);
    showNotification('Failed to fetch items. Please try again later.');
    container.innerHTML = `
      <div class="text-center py-8">
        <i data-lucide="alert-triangle" class="w-16 h-16 mx-auto text-red-400 mb-4"></i>
        <p class="text-gray-500">Failed to load items. Please try again later.</p>
      </div>
    `;
    lucide.createIcons();
  }
};

const uploadItem = async (formData) => {
  const token = getAuthToken();
  if (!token) {
    throw new UploadError('Please log in to upload items');
  }

  const response = await fetch(`${CONFIG.API_BASE_URL}/items`, {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${token}`
    },
    body: formData
  });

  const data = await response.json();
  
  if (!response.ok) {
    throw new UploadError(
      data.error || 'Failed to upload item',
      `Status: ${response.status}, Response: ${JSON.stringify(data)}`
    );
  }

  return data;
};

// Form Handling
const handleFormSubmit = async (event) => {
  event.preventDefault();
  const form = event.target;
  const submitButton = form.querySelector('button[type="submit"]');
  const originalButtonText = submitButton.textContent;

  try {
    // Validate form data
    const requiredFields = ['name', 'price', 'description', 'location', 'category'];
    for (const field of requiredFields) {
      const input = form.querySelector(`#${field}`);
      if (!input.value.trim()) {
        throw new UploadError(`Please fill in the ${field.replace(/([A-Z])/g, ' $1').toLowerCase()}`);
      }
    }

    // Validate files
    const files = form.querySelector('#images').files;
    validateFiles(files);

    // Prepare form data
    const formData = new FormData(form);

    // Update UI
    submitButton.disabled = true;
    submitButton.innerHTML = `
      <i data-lucide="loader" class="w-5 h-5 animate-spin inline-block"></i>
      Uploading...
    `;
    lucide.createIcons();

    // Upload
    const item = await uploadItem(formData);
    showNotification('Item uploaded successfully!', 'success');
    
    // Reset form
    form.reset();
    document.getElementById('imagePreview').innerHTML = '';
    document.getElementById('uploadFormContainer').classList.add('hidden');
    
    // Refresh items
    await fetchItems();
  } catch (error) {
    console.error('Upload error:', error);
    showNotification(error.message);
    if (error.technical) {
      console.error('Technical details:', error.technical);
    }
  } finally {
    submitButton.disabled = false;
    submitButton.textContent = originalButtonText;
  }
};

// Initialize
document.addEventListener('DOMContentLoaded', () => {
  // Initial items fetch
  fetchItems();

  // Setup form handling
  const form = document.getElementById('uploadForm');
  form.addEventListener('submit', handleFormSubmit);

  // Setup image input handling
  const imageInput = document.getElementById('images');
  imageInput.addEventListener('change', handleImagePreview);

  // Setup upload button toggle
  const uploadButton = document.getElementById('uploadButton');
  const uploadFormContainer = document.getElementById('uploadFormContainer');
  uploadButton.addEventListener('click', () => {
    uploadFormContainer.classList.toggle('hidden');
  });

  // Setup search with debounce
  const searchInput = document.getElementById('searchQuery');
  let debounceTimeout;
  searchInput.addEventListener('input', (e) => {
    clearTimeout(debounceTimeout);
    debounceTimeout = setTimeout(() => {
      fetchItems(e.target.value.trim());
    }, CONFIG.DEBOUNCE_DELAY);
  });

  // Initialize Lucide icons
  lucide.createIcons();
});

  </script>
</body>
</html>